name: Deploy via SSM (server build)

on:
  push:
    branches: ["main"]

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ap-northeast-2
      INSTANCE_ID: i-08bf99a0d6dc02e0d
    steps:
      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::YOUR_ACCOUNT_ID:role/YOUR_GITHUB_ASSUME_ROLE
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy on EC2 via SSM (git pull + build + pm2 reload)
        run: |
          aws ssm send-command \
            --instance-ids "${INSTANCE_ID}" \
            --document-name "AWS-RunShellScript" \
            --parameters commands='[
              "set -euo pipefail",
              "APP=/home/ubuntu/portfolio",
              "cd $APP",
              "git fetch --all",
              "git reset --hard origin/main",
              "pnpm install --frozen-lockfile",
              "pnpm build",
              "cd $APP/.next/standalone",
              "pm2 reload portfolio --update-env || pm2 restart portfolio --update-env",
              "pm2 save",
              "echo DEPLOY_OK"
            ]'